# 11) Technical Design for Codex (개발 설계 요구사항)

> 이 문서는 “기획 → 개발 설계”로 변환할 때 Codex가 지켜야 할 기술 요구사항을 정리한다.  
> 작업 규칙(경로/권한)은 `00_CODEX_RULES.md` 를 최우선으로 따른다.

## 1. 목표 아키텍처(요약)
- 클라이언트(웹): 게임 실행/렌더/입력/UI
- GameCore(순수 로직): 전투/웨이브/룰/랜덤/이벤트 로그
- Content: JSON 로더 + 스키마 검증 + 참조 무결성 체크
- (선택) 서버: 계정/클라우드 세이브/리더보드

## 2. 모듈 분리(권장)
### 2.1 GameCore (테스트 가능한 순수 로직)
- 책임:
  - RNG(시드)
  - 웨이브 스폰 스케줄
  - 유닛 공격/스킬/시너지 계산
  - 결과 산정(클리어/실패)
- 금지:
  - DOM/Canvas/Phaser 같은 렌더 의존
  - 네트워크 호출

### 2.2 Render/Engine Layer
- 책임:
  - 스프라이트/애니메이션 재생
  - 이펙트/사운드
  - 입력(드래그/버튼)
- GameCore에서 나온 “상태/이벤트”를 받아 화면에 표현

### 2.3 UI Layer
- 로비/결과/업그레이드/도감 등
- GameCore 상태와 분리(상태 관리 스토어를 두면 좋음)

## 3. 재현 가능한 RNG(필수)
### 3.1 요구사항
- 모든 랜덤 결과는 `runSeed` 기반 PRNG에서만 나오게 한다.
- 런 시작 시 `runSeed`를 기록한다.
- 중요 이벤트를 `eventLog`로 기록해 리플레이/버그 재현 가능하게 한다.

### 3.2 설계 포인트
- PRNG는 “플랫폼/언어가 바뀌어도 같은 결과”가 나오도록 단순한 알고리즘 권장(Xorshift 등)
- RNG 사용 위치를 제한:
  - 소환/드랍/크리티컬 등
  - “프레임 타이밍”에 따라 결과가 달라지지 않게(틱 기반 또는 이벤트 기반)

## 4. 저장/불러오기(필수)
### 4.1 저장 단위
- 런 중 자동 저장(웨이브 종료 시점 권장)
- 런 결과 저장(히스토리)
- 메타 진행 저장(업그레이드/해금)

### 4.2 저장 포맷(예시)
- `profile.json` (메타)
- `run_save.json` (진행 중 런)
- `run_history.json` (최근 N개 기록)

> Codex: 저장 포맷에 `contentVersion`과 `runSeed`를 반드시 포함.

## 5. 데이터 스키마/무결성(필수)
- `UnitDef.skillIds`가 `skills.json`에 존재하는지 검증
- `Wave.enemyId`가 `enemies.json`에 존재하는지 검증
- 태그/시너지 참조 검증

## 6. 테스트 전략(권장)
- GameCore는 단위 테스트 가능해야 한다.
- “시드 고정”으로 전투 결과를 스냅샷 테스트 가능
- 밸런스 테스트(시뮬레이션) 스켈레톤 제공:
  - 랜덤 시드 1000개
  - 평균 도달 웨이브/클리어율/분산 출력

## 7. 서버(선택) — ASP.NET Core + MS-SQL 가정
- 엔드포인트:
  - `POST /api/run/result` (런 결과 업로드)
  - `GET /api/profile` / `PUT /api/profile` (메타 저장)
  - `GET /api/leaderboard`
- MVP는 서버 없이 로컬 저장으로 시작해도 됨.

## 8. Codex에게 요구하는 개발 산출물(체크리스트)
- [ ] 컨텐츠 로더 + 스키마 검증기
- [ ] Seeded RNG 구현 + 런 시드 생성/저장
- [ ] GameCore 전투/웨이브 최소 구현
- [ ] UI: 로비 → 런 → 결과 플로우 연결
- [ ] 저장/불러오기(중단 후 재개)
