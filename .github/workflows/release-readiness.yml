name: release-readiness

on:
  push:
  pull_request:

jobs:
  release-readiness:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Generate baseline gate artifacts (PR only)
        if: github.event_name == 'pull_request'
        run: |
          set -euo pipefail
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          mkdir -p .tmp/release-readiness/baseline
          git worktree add --detach .tmp/release-readiness/base-worktree "${BASE_SHA}"
          pushd .tmp/release-readiness/base-worktree >/dev/null
          node tools/perf/run-and-check.js --profile=ci-mobile-baseline --iterations=200 --output=../baseline/perf-gate-report.json
          node tools/balance/run-tuning-gate.js --chapter=chapter_1 --output=../baseline/tuning-gate-report.chapter_1.json --top-candidates=10
          node tools/balance/run-tuning-gate.js --chapter=chapter_2 --output=../baseline/tuning-gate-report.chapter_2.json --top-candidates=10
          popd >/dev/null
          git worktree remove --force .tmp/release-readiness/base-worktree

      - name: Run full release-readiness checks
        run: python tools/check-release-readiness.py

      - name: Upload release-readiness artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: release-readiness-artifacts
          path: .tmp/release-readiness/*.json
          if-no-files-found: warn
