name: release-readiness

on:
  push:
  pull_request:

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  release-readiness:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Restore PR trend history cache
        if: github.event_name == 'pull_request'
        uses: actions/cache/restore@v4
        with:
          path: .tmp/release-readiness/history
          key: release-readiness-pr-${{ github.event.pull_request.number }}-${{ github.run_id }}
          restore-keys: |
            release-readiness-pr-${{ github.event.pull_request.number }}-

      - name: Generate baseline gate artifacts (PR only)
        if: github.event_name == 'pull_request'
        run: |
          set -euo pipefail
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          mkdir -p .tmp/release-readiness/baseline
          git worktree add --detach .tmp/release-readiness/base-worktree "${BASE_SHA}"
          pushd .tmp/release-readiness/base-worktree >/dev/null
          node tools/perf/run-and-check.js --profile=ci-mobile-baseline --iterations=200 --output=../baseline/perf-gate-report.json
          CHAPTER_IDS=$(python - <<'PY'
import json
from pathlib import Path

path = Path("content/chapter-presets.json")
if not path.exists():
    raise SystemExit(f"missing chapter presets file: {path}")

parsed = json.loads(path.read_text(encoding="utf-8"))
chapters = parsed.get("chapters", {})
if not isinstance(chapters, dict) or not chapters:
    raise SystemExit("invalid chapter presets: expected non-empty object at 'chapters'")

chapter_ids = sorted(
    chapter_id for chapter_id in chapters.keys() if isinstance(chapter_id, str) and chapter_id.strip()
)
if not chapter_ids:
    raise SystemExit("no valid chapter IDs found in chapter presets")

print(" ".join(chapter_ids))
PY
          )
          for CHAPTER_ID in ${CHAPTER_IDS}; do
            node tools/balance/run-tuning-gate.js --chapter="${CHAPTER_ID}" --output="../baseline/tuning-gate-report.${CHAPTER_ID}.json" --top-candidates=10
          done
          popd >/dev/null
          git worktree remove --force .tmp/release-readiness/base-worktree

      - name: Run full release-readiness checks
        env:
          RELEASE_READINESS_REQUIRE_BASELINE: ${{ github.event_name == 'pull_request' && '1' || '0' }}
        run: python tools/check-release-readiness.py

      - name: Archive trend report to PR history cache
        if: github.event_name == 'pull_request'
        run: |
          set -euo pipefail
          mkdir -p .tmp/release-readiness/history
          if [ -f .tmp/release-readiness/trend-diff-report.json ]; then
            cp .tmp/release-readiness/trend-diff-report.json ".tmp/release-readiness/history/trend-diff-report.pr-${{ github.event.pull_request.number }}.run-${{ github.run_id }}.${{ github.sha }}.json"
          fi

      - name: Save PR trend history cache
        if: github.event_name == 'pull_request'
        uses: actions/cache/save@v4
        with:
          path: .tmp/release-readiness/history
          key: release-readiness-pr-${{ github.event.pull_request.number }}-${{ github.run_id }}

      - name: Upsert threshold proposal PR comment
        if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('node:fs');
            const marker = '<!-- release-readiness-threshold-proposal -->';
            const proposalPath = '.tmp/release-readiness/trend-threshold-proposal-comment.md';

            if (!fs.existsSync(proposalPath)) {
              core.warning(`threshold proposal markdown is missing: ${proposalPath}`);
              return;
            }

            const markdown = fs.readFileSync(proposalPath, 'utf8').trim();
            if (!markdown) {
              core.warning(`threshold proposal markdown is empty: ${proposalPath}`);
              return;
            }

            const body = `${marker}\n${markdown}`;
            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;

            try {
              const comments = await github.paginate(github.rest.issues.listComments, {
                owner,
                repo,
                issue_number,
                per_page: 100,
              });
              const existing = comments.find((comment) => typeof comment.body === 'string' && comment.body.includes(marker));

              if (existing) {
                await github.rest.issues.updateComment({
                  owner,
                  repo,
                  comment_id: existing.id,
                  body,
                });
              } else {
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number,
                  body,
                });
              }
            } catch (error) {
              core.warning(`failed to upsert threshold proposal comment: ${error.message}`);
            }

      - name: Upload release-readiness artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: release-readiness-artifacts
          path: |
            .tmp/release-readiness/*.json
            .tmp/release-readiness/*.md
            .tmp/release-readiness/history/*.json
          if-no-files-found: warn
